#!/bin/bash

# ##################################################
# Print usage and manage opts
# ##################################################

github_runner_registration_token=""
github_runner_label=""
github_runner_url=""

source base

function show_usage {
  echo "Usage: $0 <flags>"
  echo "  -t: Specify GitHub registration token for runner"
  echo "  -l: Specify GitHub runner label(s)"
  echo "  -r: Specify GitHub repo url / runner url"
  echo "  -i: Specify VM IP address"
  echo "  -h: Show this help message"
}

while getopts "t:l:r:i::h" opt; do
  case $opt in
    t  ) github_runner_registration_token="$OPTARG";;
    l  ) github_runner_label="$OPTARG";;
    r  ) github_runner_url="$OPTARG";;
    i  ) vm_ip_address="$OPTARG";;
    h  ) show_usage; exit 0;;
    \? ) log_debug "Invalid option: -$OPTARG"; show_usage; exit 1;;
    :  ) log_debug "Option -$OPTARG requires an argument."; show_usage; exit 1;;
  esac
done

source base.opts

if [ -z "$github_runner_registration_token" ] || [ -z "$github_runner_label" ] || [ -z "$github_runner_url" ]; then
        log_debug 'Missing -t or -l or -r' >&2
        exit 1
fi

# ##################################################
# Initialize script
# ##################################################

if [[ -f .env ]]; then
  source .env
  log_debug "Environment variables loaded from .env file."
else
  log_debug "Error: .env file not found."
  exit 1
fi

trap "log_output \"[OWNER] 🚦 Stopping github.runner.kickoff script\"; exit 1" SIGINT

# ##################################################
# Start runner on guest VM
# ##################################################

log_output "[MA] 💤 Waiting for SSH to be available on VM"
until [ "$(ssh -q -i "$VM_SSH_KEY_PATH" -o ConnectTimeout=2 -o StrictHostKeyChecking=no -oBatchMode=yes "$VM_USERNAME@$vm_ip_address" pwd)" ]; do
  sleep 1
done

log_output "[OWNER] 🔨 Configuring runner on VM"
ssh -q "$VM_USERNAME@$vm_ip_address" -i "$VM_SSH_KEY_PATH" \
  "./actions-runner/config.sh --url $github_runner_url \
  --token $github_runner_registration_token \
  --ephemeral --name $RUNNER_NAME \
  --labels $github_runner_label \
  --unattended --replace" \
  >/dev/null
if [ $? -eq 0 ]; then
  log_output "[OWNER] 🏃 Configured runner successfully."
else
  log_output "[OWNER] 🏃 Configuration of runner failed."
  exit 1
fi

log_output "[OWNER] 🏃 Starting runner on VM"
ssh -q "$VM_USERNAME@$vm_ip_address" -i "$VM_SSH_KEY_PATH" "source ~/.zprofile && ./actions-runner/run.sh" 2>&1 | sed -nru 's/^(.+)$/[GUEST] 📀 \1/p' | stream_output &
log_output "[OWNER] 🏃 Runner process started with PID: $!"
